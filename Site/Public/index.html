<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <title>ShineMax | Página Inicial</title>

        <link rel="icon" href="Img/icones/logo.png" />
        <link rel="stylesheet" href="CSS/Shinemax.css" />
    </head>

    <body>
        <a name="topo"></a>

        <div class="carrossel">
            <div class="container" id="img">
                <img id="img1" src="Img/fundos/fundo.png" width="100%" />
                <img id="img2" src="Img/fundos/fundo1.png" width="100%" />
                <img id="img3" src="Img/fundos/fundo2.png" width="100%" />
                <img id="img4" src="Img/fundos/fundo3.png" width="100%" />
                <img id="img5" src="Img/fundos/fundo4.png" width="100%" />
            </div>
        </div>

        <div class="header">
            <div class="container">
                <!-- Barra de cima -->
                <a href="index.html">
                    <div class="shinemax">
                        <img src="Img/icones/logo.png" height="50px" />
                        ShineMax
                    </div>
                </a>
                <ul id="ocultar" class="barra">
                    <li>Home</li>
                    <li><a href="HTML/Filmes.html">Filmes</a></li>
                    <li><a href="HTML/Series.html">Séries</a></li>
                    <li><a href="HTML/Animes.html">Animes</a></li>
                    <div>
                        <img onclick="mostrar('pesquisa')" style="filter: invert(1)" src="Img/icones/pesquisa.png" height="30px" width="30px" />
                    </div>
                    <div class="usuario">
                        <span class="icone-login">
                            <img src="Img/icones/usuario.png" width="50px" />
                            <div class="menu-login">
                                <div id="online" style="display: none">
                                    <li id="b_usuario">Usuario</li>
                                    <li><a href="HTML/Configuracões.html"> Configurações </a></li>
                                    <li>
                                        <a href="index.html" onclick="limparSessao()">sair</a>
                                    </li>
                                </div>
                                <div id="offline">
                                    <li><a href="HTML/Login.html"> Login </a></li>
                                    <li><a href="HTML/Cadastro.html"> Cadastro </a></li>
                                </div>
                            </div>
                        </span>
                    </div>
                </ul>
                <!-- Fim da Barra-->
            </div>

            <div id="pesquisa" style="display: none">
                <div class="buttonpesquisar">
                    <img src="Img/icones/pesquisa.png" style="filter: invert(1)" width="20px" alt="Buscar" />
                    <input type="search" class="inputpesquisa" placeholder="Buscar..." />
                </div>
            </div>
        </div>

        <div class="conteudo">
            <div class="destaque">Destaques</div>
            <div class="informaçao">
                <div id="titulo"></div>
                <div id="texto"></div>

                <div id="button">
                    <a href="" class="alinhar">
                        <img src="Img/icones/play.png" height="20px" width="20px" />
                        Assistir
                    </a>
                </div>
            </div>
        </div>

        <div class="filmes">
            <!-- Sessão de Filmes -->
            <h4 class="title">Filmes Populares</h4>
            <div class="buttons">
                <button class="buttonrolar" onclick="moverEsquerda()">
                    <div class="arrow-left"></div>
                </button>
                <div class="container" id="scroll">
                    <div class="corpo" id="mylist">
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/creed III.png" alt="" />
                            <h4 class="text">Creed III</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/a mulher rei.png" alt="" />
                            <h4 class="text">A Mulher Rei</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/avatar.png" alt="" />
                            <h4 class="text">Avatar O Caminho da Água</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/esquema de risco.png" alt="" />
                            <h4 class="text">Esquema de Risco</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/john wick 4.png" alt="" />
                            <h4 class="text">John Wick 4</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/kingsman a origem.png" alt="" />
                            <h4 class="text">Kingsman A Origem</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/uma noite no museu o retorno de kahmurah.png" alt="" />
                            <h4 class="text">Uma Noite no Museu O Retorno de Kahmurah</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/wifi ralph.png" alt="" />
                            <h4 class="text">Wifi Ralph</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/adao negro.png" alt="" />
                            <h4 class="text">Adão Negro</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/shazan.png" alt="" />
                            <h4 class="text">Shazan</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/homem aranha de volta ao lar.png" alt="" />
                            <h4 class="text">Homem Aranha de Volta ao Lar</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/homem de ferro 3.png" alt="" />
                            <h4 class="text">Homem de Ferro 3</h4>
                        </div>
                    </div>
                </div>
                <button class="buttonrolar" onclick="moverDireita()">
                    <div class="arrow-right"></div>
                </button>
            </div>
            <h4 class="title">Tops da Semana</h4>

            <div class="buttons">
                <button class="buttonrolar" onclick="moverEsquerda2()">
                    <div class="arrow-left"></div>
                </button>
                <div class="container" id="scroll2">
                    <div class="corpo" id="mylist">
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/kung fu panda 3.png" alt="" />
                            <h4 class="text">Kung Fu Panda 3</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/kingsman a origem.png" alt="" />
                            <h4 class="text">Kingsman A Origem</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/uma noite no museu o retorno de kahmurah.png" alt="" />
                            <h4 class="text">Uma Noite no Museu O Retorno de Kahmurah</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/avatar.png" alt="" />
                            <h4 class="text">Avatar o Caminho da Água</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/john wick 4.png" alt="" />
                            <h4 class="text">John Wick 4</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/gato de botas.png" alt="" />
                            <h4 class="text">Gato de Botas 3</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/a mulher rei.png" alt="" />
                            <h4 class="text">A Mulher Rei</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/creed III.png" alt="" />
                            <h4 class="text">Creed III</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/eu sou a lenda.png" alt="" />
                            <h4 class="text">Eu sou a Lenda</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/carros 3.png" alt="" />
                            <h4 class="text">Carros 3</h4>
                        </div>
                    </div>
                </div>
                <button class="buttonrolar" onclick="moverDireita2()">
                    <div class="arrow-right"></div>
                </button>
            </div>

            <h4 class="title">Recomendados</h4>
            <div class="buttons">
                <button class="buttonrolar" onclick="moverEsquerda3()">
                    <div class="arrow-left"></div>
                </button>
                <div class="container" id="scroll3">
                    <div class="corpo" id="mylist">
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Series/peaky blinders.png" alt="" />
                            <h4 class="text">Peaky Blinders</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Series/chicago med.png" alt="" />
                            <h4 class="text">Chicago Med</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/vingadores guerra infinita.png" alt="" />
                            <h4 class="text">Vingadores Guerra Infinita</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Series/the witcher.png" alt="" />
                            <h4 class="text">The Witcher</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Series/the last of us.png" alt="" />
                            <h4 class="text">The Last Of Us</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/homem de ferro 3.png" alt="" />
                            <h4 class="text">Homem de Ferro 3</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/gato de botas.png" alt="" />
                            <h4 class="text">Gato de Botas</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Series/the flash.png" alt="" />
                            <h4 class="text">The Flash</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/operação big hero.png" alt="" />
                            <h4 class="text">Operação Big Hero</h4>
                        </div>
                        <div class="imgs">
                            <img class="img" src="Img/Capas/Filmes/minions 2.png" alt="" />
                            <h4 class="text">minions 2</h4>
                        </div>
                    </div>
                </div>
                <button class="buttonrolar" onclick="moverDireita3()">
                    <div class="arrow-right"></div>
                </button>
            </div>
            <!-- Fim da Parte dos Filmes -->
        </div>

        <div id="graficos">
            <div id="grafico1">
                <div class="graph" style="width: 450px">
                    <h2>Numero de Avaliações do Site</h2>
                    <canvas id="myChartCanvas"></canvas>
                </div>
                <h3 class="votosContados">
                    Total de Avaliações:
                    <div id="votosContados"></div>
                </h3>
                <div class="btngrafico" style="display: none">
                    <button onclick="cadastrarAvaliacao('aindaNaoSei')">Ainda Não Sei</button>
                    <button onclick="cadastrarAvaliacao('gostei')">Gostei</button>
                    <button onclick="cadastrarAvaliacao('naoGostei')">Não Gostei</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <!-- Barra Baixo -->
            <div class="container">
                <div class="redes">Siga-nos nas Redes Sociais</div>
                <div class="redesocial">
                    <a href="https://github.com/TheoMesquita/Shinemax">
                        <img src="Img/icones/git.png" style="filter: invert(1)" width="30px" />
                    </a>
                    <a href="https://web.facebook.com/theofilo.mesquita.5">
                        <img src="Img/icones/facebook.png" width="30px" />
                    </a>
                    <a href="https://www.instagram.com/010_theo/">
                        <img src="Img/icones/instagram.png" width="30px" />
                    </a>
                    <a href="https://www.youtube.com/c/ghostfenix">
                        <img src="Img/icones/youtube.png" width="30px" />
                    </a>
                </div>
                <a href="#" class="contato">Algum problema? Contate-nos</a>
                <div class="contatos">
                    <a href="mailto:theomesquita@hotmail.com">E-mail: theomesquita@hotmail.com</a>
                    <a href="https://wa.me/5511986773099">Celular: (11) 98677-3099</a>
                </div>
                <div class="copy">&copy; Copyright Todos os direitos reservados</div>
                <a class="topo" href="#topo">^</a>
            </div>
            <!-- Fim da Barra -->
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="JS/Acesso.js"></script>
        <script src="JS/Carrossel.js"></script>
        <script src="JS/Pesquisar.js"></script>
        <script src="JS/Shinemax.js"></script>
    </body>
</html>
<script>
    b_usuario.innerHTML = sessionStorage.apelido;

    let proximaAtualizacao;

    window.onload = obterDadosGraficos();

    function obterDadosGraficos() {
        obterDadosGrafico(1);
    }

    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de voto.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function obterDadosGrafico(idVoto) {
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/grafico/ultimas/${idVoto}`, { cache: "no-store" })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                        plotarGrafico(resposta, idVoto);
                    });
                } else {
                    console.error("Nenhum dado encontrado ou erro na API");
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e,
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idVoto) {
        console.log("iniciando plotagem do gráfico...");
        console.log(resposta);
        // Criando estrutura para plotar gráfico - labels
        let labels = ["Ainda não sabe", "Gostei", "Não gostei"];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [
                {
                    label: "Avaliações dos Usuarios",
                    data: [resposta[0]["count(nota)"], resposta[1]["count(nota)"], resposta[2]["count(nota)"]],
                    Color: "rgb(255, 0, 0)",
                    borderWidth: 1,
                },
            ],
        };

        console.log("----------------------------------------------");
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":');
        console.log(resposta);

        console.log("----------------------------------------------");
        console.log("O gráfico será plotado com os respectivos valores:");
        console.log("Labels:");
        // console.log(labels);
        console.log("Dados:");
        // console.log(dados.datasets);
        console.log("----------------------------------------------");

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: "doughnut",
            data: dados,
            options: { animation: false },
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(document.getElementById(`myChartCanvas`), config);

        setTimeout(() => atualizarGrafico(idVoto, dados, myChart), 10);
    }

    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas,

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idVoto, dados, myChart) {
        fetch(`/grafico/tempo-real/${idVoto}`, { cache: "no-store" })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (novoRegistro) {
                        // console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                        // console.log(`Dados atuais do gráfico:`);
                        // console.log(dados);

                        if (novoRegistro[0].nota == dados.labels[dados.labels.length - 1]) {
                            console.log("---------------------------------------------------------------");
                            console.log("Como não há dados novos para captura, o gráfico não atualizará.");
                            console.log("Horário do novo dado capturado:");
                            console.log("novo registro " + novoRegistro[0].nota);
                            console.log("Horário do último dado capturado:");
                            console.log("---------------------------------------------------------------");
                        } else {
                            // tirando e colocando valores no gráfico
                            dados.labels.shift(); // apagar o primeiro
                            dados.labels.push("Ainda não sabe"); // incluir um novo momento
                            dados.labels.shift(); // apagar o primeiro
                            dados.labels.push("Gostei"); // incluir um novo momento
                            dados.labels.shift(); // apagar o primeiro
                            dados.labels.push("Não gostei");

                            dados.datasets[0].data.shift(); // apagar o primeiro de umidade
                            dados.datasets[0].data.push(novoRegistro[0]["count(nota)"]); // incluir uma nova medida de umidade
                            dados.datasets[0].data.shift(); // apagar o primeiro de umidade
                            dados.datasets[0].data.push(novoRegistro[1]["count(nota)"]); // incluir uma nova medida de umidade
                            dados.datasets[0].data.shift(); // apagar o primeiro de umidade
                            dados.datasets[0].data.push(novoRegistro[2]["count(nota)"]); // incluir uma nova medida de umidade

                            votosContados.innerHTML = `${novoRegistro[0]["count(nota)"] + novoRegistro[1]["count(nota)"] + novoRegistro[2]["count(nota)"]}`;
                            console.log("esse é o novo registro " + novoRegistro[0]["count(nota)"], novoRegistro[1]["count(nota)"], novoRegistro[2]["count(nota)"]);

                            myChart.update();
                        }

                        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                        proximaAtualizacao = setTimeout(() => atualizarGrafico(idVoto, dados, myChart), 2000);
                    });
                } else {
                    console.error("Nenhum dado encontrado ou erro na API");
                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idVoto, dados, myChart), 2000);
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function cadastrarAvaliacao(avaliacao) {
        fetch("/grafico/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                avaliacaoServer: avaliacao,
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok == true) {
                    console.log("Cadastro ok");
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

        return false;
    }
</script>
